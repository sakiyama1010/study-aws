# ストレージサービス

- サービス
  - AWS Snowball
  - Amazon EBS
  - Amazon EFS
  - Amazon S3
  - Amazon Glacier
  - AWS Storage Gateway
- タイプ
  - ブロックストレージ
    - データを物理的なディスクにブロック単位で管理する
    - DBや仮想サーバのイメージ保存領域のような頻繁に更新されたり高速なアクセスが必要とされる用途で使われる
    - プロトコル：SATA,SCSI,FC(規格)
    - EBSが該当
  - ファイルストレージ
    - ブロックストレージ上にファイルシステムを構成し、ファイル単位で管理する
    - 複数のクライアントからネットワーク経由でファイルアクセスする用途で使われる
    - プロトコル：CIFS,NFS
      - Common Internet File System:Windowsのファイル共有の仕組みであるSMB（the Server Message Block）をWindows以外でも利用できるようにしたもの
      - Network File System:主にUNIX系OSで利用される分散ファイルシステム、および、そのための通信規約
    - EFSが該当
  - オブジェクトストレージ
    - ファイルに任意のメタデータを追加しオブジェクトとして管理する
    - ファイル内容をストレージ内で直接操作することはできない
    - 作成済みデータに対するHTTP経由の操作が可能
    - プロトコル：HTTP,HTTPS
    - 更新頻度の少ないデータや大容量のマルチメディアコンテンツを保存する用途で使われる
    - S3,Glacierが該当

## Amazon EBS（Elastic Block Store）

- EC2インスタンスに割り当てられる**ブロックストレージ**
  - 物理ハードディスクドライブと同じように利用する
- EC2インスタンスにアタッチ（取り付け）して利用
- 異なるAZにあるEBSのアタッチは不可
  - EBSのスナップショットを取り、そこからEBSボリュームを作成
- 作成したボリュームは1つのEC2インスタンスだけにアタッチできる
  - 同時に2つ以上のインスタンスからアクセスすることはできない
  - 一部のボリュームタイプでは複数インスタンスのアタッチ（マルチアタッチ）に対応してる
    - 利用できるインスタンスタイプやリージョンが限られている

### ボリュームタイプ

- SSD
  - 汎用SSD(gp2、gp3)
  - プロビジョンドOPS SSD(io1、io2)
- HDD
  - スループット最適化 HDD(st1)
  - コールドHDD(sc1)
  - マグネティック(旧世代)

最新のボリューム情報↓
<https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ebs-volume-types.html#>

### ベースライン性能

- ベースライン性能
  - ベースとなる性能指標
    - IOPS:3IOPS/GB(最低100IOPS)から最大10000IOPS/ボリュームまで
- バースト性能
  - 処理量の一時的な増加に対応可能
  - バースト性能に頼ったサイジングはしないこと

### EBSの拡張変更

- 変更
  - 変更後の同一ボリュームに対しての変更は6時間以上あけること
- 容量拡張
  - 1ボリュームあたり最大16TB
  - サイズ拡張は何度でも可能
  - 使用中のEBSを拡張したらECS上のOSにも応じたファイルシステム拡張作業をすること(Linuxでいうresize2fs,xfs_growfs)
  - 縮小はできない
    - 一時的な容量追加は新規EBSを作成・アタッチし、不要になったらデタッチする
- ボリュームタイプの変更
  - タイプ変更は可能
  - iopsの変更には最大24時間以上かかることもある
    - Modiftying->CompleteになればOK
  - 例:gp2で作成したがIOPS不足になりio1に変更したい
    - 追加のプロビジョニングを実施することも可能
      - 必要に応じてネットワークやコンピュータの設備などのリソースを提供できるよう予測し、準備しておくこと
- 可用性・耐久性
  - EBSは内部的にはAZ内の複数の物理ディスクに複製されている
    - 物理的な故障があっても利用者が意識することはない
    - SLAは99.99%
  - EBSは定期的なスナップショットをとることも可能
    - スナップショットからEBSを作成し、インスタンスにアタッチする
- セキュリティ
  - ストレージ自体を暗号化するオプション有
    - 暗号化したボリュームから取得したスナップショットも暗号化される
    - 暗号化処理はインスタンスが稼働するホストで実施されるので、EBS間をまたぐデータ通信も暗号化される
  - すでに作成済みのEBSを暗号化したい場合の手順
    - ボリュームのスナップショットを取得
    - スナップショットを暗号化
    - 暗号化されたスナップショットから新規EBS作成
    - インスタンスにアタッチしているボリュームを入れ替え
  - 既存のブートボリュームを暗号化する場合
    - AMIを取得してコピー時に暗号化
    - コピーされたAMIからインスタンスを作る

## Amazon EFS(Elastic File System)

- **ファイルストレージ**サービス
- 容量無制限で複数のEC2インスタンスから同時にアクセス可能
- 接続はNFSプロトコルを利用
- amazon-efs-utilsツール

### 構成要素

- ファイルシステム
  - 3箇所以上のAZに保存される
- マウントターゲット
  - 作成したファイルシステムにアクセスするためにAZごとにサブネットを指定する
  - ターゲットポイント(FQDN)が1つ作成される
    - EC2からは上記にアクセスする
  - 各AZごとのマウントターゲット用IPアドレスが付与される
    - EC2のある同一のAZにあるマウントターゲットのIPを返すようになっている
      - レイテンシー(遅延)を低くするため
- セキュリティグループ
  - EC2->EFS通信要件の定義が可能

### パフォーマンスモード

- 汎用パフォーマンスモード
- 最大I/Oパフォーマンスモード
  - 数百、数千台のクライアント同時アクセスへの対策(並列処理に使うデータをEFSに置くなど)
  - スループットを上げる代わりにレイテンシーも上がる
- どちらのモードがよいかはCloudwatchの`PercentIOLimit`メトリクスで見分ける
  - 性能テストを実施して判断
  - 長時間高い状態を遷移する場合、最大IOにしてもよい
  - 一度変えると変更ができないので注意

### スループット

- バーストスループット
  - 一時的なスループット上昇にも耐えられる設計
  - 1GBあたり50KB/s 保存されているデータ容量に応じてスループットと期間を設定
    - 最低バーストスループットは100MB/s
- プロビジョニングスループット
  - 任意のスループットを指定できる
  - バーストスループットよりも高い性能がほしいタイミングで利用
  - 最大1GB/秒でこれ以上は申請が必要
  - 増減可能
  - 削減は前回の作業から24時間以上あけること
- どちらのモードがよいかはCloudwatchの`BurstCreditBalance`メトリクスで見分ける
  - クレジットバランスをすべて使い切る
  - 常に減少傾向
    - プロビジョニングモード

  - Amazon FSx
    - Amazon FSx For Windowsファイルサーバー
      - SMBプロトコルを介してWindows Server（OS）上に構築されたファイルシステムを提供
      - フルマネージド
      - Windowsサーバーが提供する既存機能を利用
        - DFSR:共有フォルダ間を関連付けて自動的に複製する機能
    - Amazon FSx For Lustre

## Amazon S3

- Amazon S3（Simple Storage Service）は、AWS上で動作するストレージを提供するサービス
- ファイルストレージとの違い
  - ディレクトリ構造を持たない
  - データに対してメタデータの付与ができる
- REST,SOAP等のHTTPベースのweb APIを使ってアクセスする
- EBSのスナップショット置き場としても使われる

### 構成

- バケット
  - オブジェクトを保存する領域
  - バケット名はグローバルで一意にする必要がある
  - 作成したバケットのバケット名は変更できない
  - 一つのバケットに保存できるオブジェクト数は無制限
- オブジェクト
  - S3に格納されているデータ
  - バケット名+キー名+バージョンIDで一意になるURLを発行
    - URLが付与されるのはバケットではなくオブジェクト
  - 1つのオブジェクトサイズは最大5TB
- メタデータ
  - オブジェクトを管理するための情報
  - システム定義のメタデータ
    - 作成日時、サイズ等
  - ユーザー定義のメタデータ
    - アプリケーションで必要な情報を保持できる

### S3の耐久性と整合性

- データの複製方式(データ整合性モデル)は`結果整合性`
  - 分散システムへのデータ操作（新規追加、更新、削除）時に、分散システム全体でデータが一貫した状態になるためのモデル
  - 同一のデータを複数のストレージに分散して配置するシステムでは、あるデータを新規追加、更新、削除した時に他のストレージへ更新内容を同期することで、データの一貫性を維持
    - 更新前のデータが参照できる場合がある
    - 更新前のデータはある時点で参照できなくなる
      - 要は同期される前のストレージみたかどうかの話

#### 耐久性(ストレージクラス)

- 標準(STANDARD)
  - 耐久性:イレブンナイン
  - 可用性:99.99%
- 標準低アクセス(STANDARD-IA)
  - 標準よりも安く、参照頻度が少ないデータ向けに設定されている
  - データの読み出し容量に対する従量課金が発生する
  - 高速アクセスがしたいかつそこまで参照しないデータ向け
  - 耐久性:イレブンナイン
  - 可用性:99.9%
- 1ゾーン低アクセス(ONEZONE-IA)
  - 単一AZにのみデータ複製する
  - AZ単位の障害で復元できない恐れがある
  - サービスレベルはSTANDARD-IAと同様
  - 耐久性:イレブンナイン
  - 可用性:99.5%
- S3 Intelligent-Tiering
  - S3標準、S3標準低アクセスに自動的にデータを移す
    - 30日以上参照されなかったデータを自動で移す
    - ライフサイクル管理で自動化する
    - 頻繁に移動するとコスト高になってしまう
  - アクセス頻度が予測できないデータを保存する際に適している
  - 耐久性:イレブンナイン
  - 可用性:99.9%
- S3 Glacier
  - アーカイブ目的のデータを保存するストレージクラス
  - オブジェクト新規作成時に選択できない
    - ライフサイクル管理機能を使ってGlacierを指定する形になる
  - 事前にアクセスをリクエストする必要がある
  - 利用例
    - 以下の条件でバックアップデータの保存先をオンプレミスからAmazon S3に移行したい
      - 年に1回程度バックアップデータからの復元が発生する
      - データを取り出す時は数時間の遅延が発生しても問題ない
  - 耐久性:イレブンナイン
  - 可用性:99.99%
- S3 Glacier Deep Archive
  - 一番安い、取り出しにかなりの時間がかかる
  - 半年は保存される前提

### ライフサイクル管理

- 移行アクション
  - データの利用頻度に応じてストレージクラスを変更するアクション
- 有効期限アクション
  - 指定された期限を越えたオブジェクトを削除するアクション
  - 保存容量に応じて従量課金されるため、コスト削減につながる

### バージョニング

- オブジェクトの世代管理を自動的に行う
- バケット単位で有効/無効を指定する
- 更新前と更新後の両方のオブジェクトが保存され、各オブジェクトに固有のバージョンIDが割り当てられる
- オブジェクトの削除時には、オブジェクトを完全に削除する代わりに削除フラグを意味する削除マーカーが付与され、それが最新のバージョンとなる
- MFA Delete
  - S3のバージョニング機能で世代管理されているオブジェクトを削除する際に、MFAデバイス認証が必要となる機能
    - MFA（Multi-Factor Authentication：多要素認証）
  - AWSではMFAアプリケーションをインストールしたデバイス（MFAデバイス）に表示されたワンタイムパスワードを、AWSアカウントやパスワードと一緒に入力します。MFAデバイスには、YubiKeyのような物理デバイスや、Google Authenticatorのようなスマートフォンにインストールして利用する仮想デバイスがある
  - ルートアカウント（AWSとの契約を行ったアカウント）と紐付いたMFAデバイスによる認証が求められる
  - MFA Deleteが有効になったバケットのオブジェクトを完全に削除する際は、ルートアカウントにてMFA認証した上で削除したいオブジェクトのバージョンIDを指定する

### Webサイトホスティング

- 静的コンテンツをwebサイトとしてホスティングできる
- 動的コンテンツはできない
  - EC2にwebサーバ構築
- 独自ドメインでホスティングする場合
  - Route 53にCNAME指定(バケット名とドメイン名を一致させる)
  - CloudFrontを配置する場合は、合わせる必要ない

### アクセス管理

- バケットポリシー
  - バケット単位のアクセスを管理
- ACL
  - オブジェクト単位
  - IPアドレス・ドメイン単位の制御はできない
- IAM
  - ユーザー単位
  - AWSアカウント単位の制御はできない
- バケットの所有者は、他のユーザーがアップロードしたオブジェクトも含めてバケット内のすべてのオブジェクトに対するフルコントロール権限を持つようにしたい
  - バケットポリシーを作成
  - バケットポリシーには、オブジェクトアップロード時にオブジェクトのフルコントロール権限をバケットの所有者に設定することを強制する

### 署名付きURL

- 非公開設定されたオブジェクトに対して有効期限のついたURLを発行する
  - AWSアカウントを持っていないユーザーでも一時的にアクセスが可能になる機能
- 非常に長いランダムな文字列が入るため、URLを知らない人が推測することはほぼ不可能
- ユーザー認証機能はないため、URLが漏洩すると誰でもアクセスができてしまう

### データ暗号化

- `サーバー側の暗号化`と`クライアント側の暗号化`
  - データをS3に保存する時にサーバーで暗号化する方法を、サーバー側の暗号化（Server-Side Encryption:SSE）
  - S3が管理している鍵を使用する (SSE-S3)
  - AWS KMS（AWS Key Management Service）に保存されているCMK（カスタマーマスターキー）を使用する (SSE-KMS)
  - ユーザーが管理している鍵を使用する (SSE-C)
- クライアント側の暗号化
  - AWS SDKを使ってS3に送信する前にデータが暗号化される

## Glacier

### 構成要素

- ボールド
  - アーカイブを保存するための領域
  - S3バケットに相当
  - ボールトロック
    - 「誰に対して」「どの動作を」「どの期間」「許可 or 拒否」という設定に従って、ボールト内のアーカイブに制限をかける
    - 一度ボールトロックを有効にすると、指定した期間中は設定内容を変更できない
      - 例えば「全てのユーザーに対して更新と削除を1年間拒否する」という設定をする
      - 対象のアーカイブは1年間更新や削除が禁止される
- アーカイブ
  - Glacierに格納されるデータ自身
  - S3オブジェクトに相当
  - アーカイブには一意のIDとオプション説明が割り当てられる
  - IDは138バイトのランダムな文字列が自動付与される
    - 利用者は指定できない
- インベントリ
  - 各ボールドに保存されているアーカイブ情報を収集する
  - 1日1回更新のため、タイムラグがある
  - リアルタイム状況を見る場合、ListVaults APIを実行する
- ジョブ
  - アーカイブやインベントリに対して検索をかけたり、データをダウンロードするといった要求に対しての処理を実行
  - 処理状況の管理を行う

### データ取り出しオプション

- 高速、標準、バルク
  - 待ち時間が短いほどコストはかかる
  - 次の日に見れればよいのであればバルク
- バックアップデータをAmazon S3 Glacierに保存している。緊急で5分以内に200MB分のデータを取り出したい。
  - データ取り出しオプションに「迅速取り出し」を指定して復元リクエストを実行する
  - 追加料金がかかう
  - 250MBまでのデータであれば通常1～5分以内に使用可能にする

### Glacier Select

- アーカイブデータに対してSQLを実行して条件に合ったデータを抽出する機能
- 対象のアーカイブは非圧縮CSV形式でないといけない
- 特定のデータだけをアーカイブから簡単に取り出せる

### データ暗号化

- SSLを使ったデータ転送している
- 保存するデータは標準で暗号化される

## Storage Gateway

- オンプレミスにあるデータをクラウドへ連携するための受け口を提供するサービス
- キャッシュストレージとしてEBSが使われる
- これまでの仕組みを組み合わせたインターフェースを提供するサービス
- EC2インスタンスのStorage Gateway用のAMIも用意されており、AWS上にゲートウェイを配置できる

### タイプ

- ファイルゲートウェイ
  - クライアントサーバ側でS3をNFSマウントする
  - ほぼリアルタイムでS3アップロード
  - アップロードしたファイルごとにS3オブジェクトとして扱われる
  - 読み書きはローカルディスクよりも遅い
  - NFSサーバとして利用はEFS等別サービスを検討すること
- ボリュームゲートウェイ
  - S3のデータ保存領域全体を1つのボリュームとして扱う
  - S3に保存されたデータにS3 APIを用いたアクセスはできない
  - iSCSI接続
  - ボリュームはスナップショットを取得できるため、EBS->EC2アタッチができる
  - キャッシュ型ボリューム
    - キャッシュディスク(EBS)に保存して高速アクセスできる
    - キャッシュ上に存在しないデータにアクセスする場合はS3から取得する
    - アップロードバッファボリューム
      - S3にアップロードするデータを一時的に保管するためのもの
  - 保管型ボリューム
    - すべてのデータを保存するストレージとしてローカルストレージを利用
    - データを定期的にスナップショット形式でS3に転送する
    - クラウドでバックアップするイメージ
- テープゲートウェイ
  - テープデバイスの代替としてS3やGlacierにデータをバックアップする
  - 物理のテープカートリッジを入れ替えたり、遠隔地にオフサイト保存することが不要になる
  - サードパーティー製のバックアップアプリと組み合わせることができる

### セキュリティ

- CHAP認証
  - 不正なクライアントのなりすまし防止
- データ暗号化
  - AWS KMSを使ってデータ暗号化
  - S3に保存するタイミングで保存
- 通信の暗号化
  - HTTPS通信

## その他

- クロスリージョンレプリケーション
  - S3のデータを自動的に異なるリージョンに保存する機能
  - 設定すると別のリージョンにあるバケットへ自動的にオブジェクトをコピーする
  - コピー先のリージョンは指定することができ、コピーは非同期で実行される
