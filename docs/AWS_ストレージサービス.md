# ストレージサービス

- サービス
  - AWS Snowball
  - Amazon EBS
  - Amazon EFS
  - Amazon S3
  - Amazon Glacier
  - AWS Storage Gateway
- タイプ
  - ブロックストレージ
    - データを物理的なディスクにブロック単位で管理する
    - DBや仮想サーバのイメージ保存領域のような頻繁に更新されたり高速なアクセスが必要とされる用途で使われる
    - プロトコル：SATA,SCSI,FC(規格)
    - EBSが該当
  - ファイルストレージ
    - ブロックストレージ上にファイルシステムを構成し、ファイル単位で管理する
    - 複数のクライアントからネットワーク経由でファイルアクセスする用途で使われる
    - プロトコル：CIFS,NFS
      - Common Internet File System:Windowsのファイル共有の仕組みであるSMB（the Server Message Block）をWindows以外でも利用できるようにしたもの
      - Network File System:主にUNIX系OSで利用される分散ファイルシステム、および、そのための通信規約
    - EFSが該当
  - オブジェクトストレージ
    - ファイルに任意のメタデータを追加しオブジェクトとして管理する
    - ファイル内容をストレージ内で直接操作することはできない
    - 作成済みデータに対するHTTP経由の操作が可能
    - プロトコル：HTTP,HTTPS
    - 更新頻度の少ないデータや大容量のマルチメディアコンテンツを保存する用途で使われる
    - S3,Glacierが該当

## Amazon EBS（Elastic Block Store）

- EC2インスタンスに割り当てられる**ブロックストレージ**
  - 物理ハードディスクドライブと同じように利用する
- EC2インスタンスにアタッチ（取り付け）して利用
- 異なるAZにあるEBSのアタッチは不可
  - EBSのスナップショットを取り、そこからEBSボリュームを作成
- 作成したボリュームは1つのEC2インスタンスだけにアタッチできる
  - 同時に2つ以上のインスタンスからアクセスすることはできない
  - 一部のボリュームタイプでは複数インスタンスのアタッチ（マルチアタッチ）に対応してる
    - 利用できるインスタンスタイプやリージョンが限られている

### ボリュームタイプ

- SSD
  - 汎用SSD(gp2、gp3)
  - プロビジョンドOPS SSD(io1、io2)
- HDD
  - スループット最適化 HDD(st1)
  - コールドHDD(sc1)
  - マグネティック(旧世代)

最新のボリューム情報↓
<https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ebs-volume-types.html#>

### ベースライン性能

- ベースライン性能
  - ベースとなる性能指標
    - IOPS:3IOPS/GB(最低100IOPS)から最大10000IOPS/ボリュームまで
- バースト性能
  - 処理量の一時的な増加に対応可能
  - バースト性能に頼ったサイジングはしないこと

### EBSの拡張変更

- 変更
  - 変更後の同一ボリュームに対しての変更は6時間以上あけること
- 容量拡張
  - 1ボリュームあたり最大16TB
  - サイズ拡張は何度でも可能
  - 使用中のEBSを拡張したらECS上のOSにも応じたファイルシステム拡張作業をすること(Linuxでいうresize2fs,xfs_growfs)
  - 縮小はできない
    - 一時的な容量追加は新規EBSを作成・アタッチし、不要になったらデタッチする
- ボリュームタイプの変更
  - タイプ変更は可能
  - iopsの変更には最大24時間以上かかることもある
    - Modiftying->CompleteになればOK
  - 例:gp2で作成したがIOPS不足になりio1に変更したい
    - 追加のプロビジョニングを実施することも可能
      - 必要に応じてネットワークやコンピュータの設備などのリソースを提供できるよう予測し、準備しておくこと
- 可用性・耐久性
  - EBSは内部的にはAZ内の複数の物理ディスクに複製されている
    - 物理的な故障があっても利用者が意識することはない
    - SLAは99.99%
  - EBSは定期的なスナップショットをとることも可能
    - スナップショットからEBSを作成し、インスタンスにアタッチする
- セキュリティ
  - ストレージ自体を暗号化するオプション有
    - 暗号化したボリュームから取得したスナップショットも暗号化される
    - 暗号化処理はインスタンスが稼働するホストで実施されるので、EBS間をまたぐデータ通信も暗号化される
  - すでに作成済みのEBSを暗号化したい場合の手順
    - ボリュームのスナップショットを取得
    - スナップショットを暗号化
    - 暗号化されたスナップショットから新規EBS作成
    - インスタンスにアタッチしているボリュームを入れ替え
  - 既存のブートボリュームを暗号化する場合
    - AMIを取得してコピー時に暗号化
    - コピーされたAMIからインスタンスを作る

### Amazon EFS

- **ファイルストレージ**サービス
  - Amazon FSx
    - Amazon FSx For Windowsファイルサーバー
      - SMBプロトコルを介してWindows Server（OS）上に構築されたファイルシステムを提供
      - フルマネージド
      - Windowsサーバーが提供する既存機能を利用
        - DFSR:共有フォルダ間を関連付けて自動的に複製する機能
    - Amazon FSx For Lustre

## Amazon S3

Amazon S3（Simple Storage Service）は、AWS上で動作するストレージを提供するサービス
採用されているデータ整合性モデルは結果整合性
バケット名はグローバルで一意にする必要がある
作成したバケットのバケット名は変更できない
URLが付与されるのはバケットではなくオブジェクト
一つのバケットに保存できるオブジェクト数は無制限

バケットの所有者は、他のユーザーがアップロードしたオブジェクトも含めてバケット内のすべてのオブジェクトに対するフルコントロール権限を持つようにしたい。
バケットポリシーを作成する。バケットポリシーには、オブジェクトアップロード時にオブジェクトのフルコントロール権限をバケットの所有者に設定することを強制する。

バックアップデータをAmazon S3 Glacierに保存している。緊急で5分以内に200MB分のデータを取り出したい。
データ取り出しオプションに「迅速取り出し」を指定して復元リクエストを実行する
追加料金はかかります
250MBまでのデータであれば通常1～5分以内に使用可能にする

署名付きURL
    非公開設定されたオブジェクトに対して有効期限のついたURLを発行することで、AWSアカウントを持っていないユーザーでも一時的にアクセスが可能になる機能
    非常に長いランダムな文字列が入るため、URLを知らない人が推測することはほぼ不可能
    ユーザー認証機能はないため、URLが漏洩すると誰でもアクセスができてしまう

データ整合性モデル
    「結果整合性」  
    分散システムへのデータ操作（新規追加、更新、削除）時に、分散システム全体でデータが一貫した状態になるためのモデル
    同一のデータを複数のストレージに分散して配置するシステムでは、あるデータを新規追加、更新、削除した時に他のストレージへ更新内容を同期することで、データの一貫性を維持する
        更新前のデータが参照できる場合がある
        更新前のデータはある時点で参照できなくなる
            要は同期される前のストレージみたかどうかの話

ストレージクラス
    S3 Glacier
        バックアップデータの保存先をオンプレミスからAmazon S3に移行したい。以下の条件の場合、最もコスト効果の高いストレージクラスはどれか。
        ・年に1回程度バックアップデータからの復元が発生する
        ・データを取り出す時は数時間の遅延が発生しても問題ない
    S3 Intelligent-Tiering
        S3標準、S3標準低アクセスに自動的にデータを移す
        アクセス頻度が予測できないデータを保存する際に適している
    S3 Glacier Deep Archive
        一番安い、取り出しにかなりの時間がかかる
        半年は保存される前提

データ暗号化
    「サーバー側の暗号化」と「クライアント側の暗号化

バージョニング
    オブジェクトの世代管理を自動的に行う
    オブジェクトの更新時には更新前と更新後の両方のオブジェクトが保存され、各オブジェクトに固有のバージョンIDが割り当てられる
    オブジェクトの削除時には、オブジェクトを完全に削除する代わりに削除フラグを意味する削除マーカーが付与され、それが最新のバージョンとなる

S3 Glacierには「ボールトロック」という機能があります。ボールトロックは「誰に対して」「どの動作を」「どの期間」「許可 or 拒否」という設定に従って、ボールト内のアーカイブに制限をかけます。一度ボールトロックを有効にすると、指定した期間中は設定内容を変更できません。
例えば「全てのユーザーに対して更新と削除を1年間拒否する」という設定をすれば、対象のアーカイブは1年間更新や削除が禁止されます。

クロスリージョンレプリケーションは、S3のデータを自動的に異なるリージョンに保存する機能です。クロスリージョンレプリケーションを設定すると、別のリージョンにあるバケットへ自動的にオブジェクトをコピーします。コピー先のリージョンは指定することができ、コピーは非同期で実行されます。

MFA Deleteは、S3のバージョニング機能で世代管理されているオブジェクトを削除する際に、MFAデバイス認証が必要となる機能です。MFA（Multi-Factor Authentication：多要素認証）とはIDやパスワードと同時に、指紋などのバイオメトリクスやワンタイムパスワードを利用する認証方法のことです。
AWSではMFAアプリケーションをインストールしたデバイス（MFAデバイス）に表示されたワンタイムパスワードを、AWSアカウントやパスワードと一緒に入力します。MFAデバイスには、YubiKeyのような物理デバイスや、Google Authenticatorのようなスマートフォンにインストールして利用する仮想デバイスがあります。
MFA Deleteでは、ルートアカウント（AWSとの契約を行ったアカウント）と紐付いたMFAデバイスによる認証が求められます。MFA Deleteが有効になったバケットのオブジェクトを完全に削除する際は、ルートアカウントにてMFA認証した上で削除したいオブジェクトのバージョンIDを指定します。

データをS3に保存する時にサーバーで暗号化する方法を、サーバー側の暗号化（Server-Side Encryption:SSE）
S3が管理している鍵を使用する (SSE-S3)
AWS KMS（AWS Key Management Service）に保存されているCMK（カスタマーマスターキー）を使用する (SSE-KMS)
ユーザーが管理している鍵を使用する (SSE-C)
