# ネットワーク

## リージョン(拠点)

- 国や地域

## アベイラビリティゾーン

- データセンター
- 1つのAZは複数のデータセンターで構成されている
  - 地理的、電源的に独立した場所に配置
- 障害発生時(耐障害性)の為にサーバの AZ は分けるべき
- AZ 間は高速回線で接続されており、ネットワーク遅延(レイテンシー)は基本 2ms 以内

## Amazon VPC（Virtual Private Cloud）

- ENI（Elastic Network Interface）
  - オンプレミス環境におけるNIC（Network Interface Card）と同じ役割を持つ
- プライベートなネットワークをAWS上に作成する
- IGW(インターネットへの出口)を設定すると直接インターネットに出ることができる
  - インターネットからVPC内のEC2インスタンスへアクセスするために、必要な機能
- VGWを設定するとAWS Direct Connectや専用VPN回線との接続に使う
- VPC内に入れられないサービスもある(S3,CloudWatch,DynamoDB)
- VPC エンドポイント
  - インターネットゲートウェイや NAT ゲートウェイ、NAT インスタンスなどを経由することなく、VPC と他の AWS のサービスとをプライベートに接続できる AWS のサービス

## IPアドレス

- IPアドレス(CIDRブロック)を割り振れる(/16 ～ /28の範囲で可能)
- クラスAのIP帯でも/8は取れない
- プライベートIP
  - VPC内のリソース間の通信に使用し、インターネットとは通信不可のIP
  - パブリックサブネットとプライベートサブネットにあるEC2やRDSなど、すべてのインスタンスに割り当てられる
  - AWSリソースを停止・起動しても同一のIPアドレスが使われ、AWSリソースの削除時にIPアドレスが解放される
- パブリックIP
  - インターネットと通信可能なIP
  - パブリックIPアドレスを持つAWSリソースは、パブリックDNSホスト名が割り当てられる
  - パブリックDNSホスト名
    - 名前解決要求
      - VPC外からであればパブリックIPアドレスに解決
      - VPC内からであればプライベートIPアドレスに解決
  - AWSリソースが停止する時にIPアドレスが解放され、AWSリソースが起動する時に新規のIPアドレスが割り当てられる
- Elastic IP
  - インターネットと**通信可能な固定**のパブリックIP
  - AWSリソースが削除されても同一のIPアドレスが保有され、別のAWSリソースに再び割り当てることができる
  - パブリックDNSホスト名も固定になり、Elastic IPアドレスへ名前解決される
  - AWSリソースが**停止していたり、割り当てられていない時は料金が発生**する

## サブネット

- VPCを論理的に分割したネットワーク空間(アドレスレンジ)のこと
- VPCに設定したCIDRブロックの範囲内で設定可能
  - (/16 ～ /28の範囲で可能)
- サブネット内に**1つの仮想ルータがあるイメージ**
  - サブネット内にあるEC2のDGWになる

### パブリックサブネット

- インターネットから直接通信があるサブネット
  - Route tables で 0.0.0.0/0 (デフォルトゲートウェイへの通信) がインターネットゲートウェイに流れる
  - 例:インターネットから直接アクセスされるWebサーバー等で使う

### プライベートサブネット

- Route tables で 0.0.0.0/0 (デフォルトゲートウェイへの通信) がNATゲートウェイに流れ
- 内部としか通信しないサブネット
- DBサーバはこちらに置く

### 特徴・制約

- 一つのAZに属する
- 一つのAZ内に複数作成できる
- 作成時にAZを指定する、変更できない
- 1サブネットに1ルートテーブル指定できる
  - デフォルトはメインテーブルが指定され、変更可能
- 1サブネットに1ACL指定できる
  - デフォルトのACLが指定され、変更可能
- 1VPCに対して200個のサブネット作成可能(リクエストすることで拡張可能)
- 最初の4つと最後のアドレスは予約されていて使えない
  - CIDRブロックが「172.16.0.0/24」の予約IPアドレス（利用できないIPアドレス）
    - 172.16.0.0 … ネットワークアドレス
    - 172.16.0.1 … VPCルーター用
    - 172.16.0.2 … DNSサーバー用
    - 172.16.0.3 … 将来の利用のためにAWSで予約
    - 172.16.0.255… ネットワークブロードキャストアドレス
    - 1サブネット当たりのIPアドレス数 = 2^(32 - サブネットのプレフィックス長)-5
- IPアドレスの確保な必要なサービスがある
  - ELBの場合、IPアドレス8個は抑えないといけない
- 必要以上に分割するとアドレスの浪費に繋がる

## マルチAZ

- 同一の役割を持ったサブネットを複数のAZに配置する
  - AZを跨いだ構築をすることで、AZ障害に対して耐久性の高い設計にする思想

## ルートテーブル

- VPC内で発生した通信に対して、どこへデータを転送するかを定義する機能
- ルーティング
  - ルートテーブルに従って、送信先ごとに指定したターゲットへデータを転送すること
  - サブネット内の通信がどの宛先のネットワークに対して、どのコンポーネント（IGWとかEC2とか）に転送されて欲しいかを設定する
  - ルートテーブルの紐付けがないサブネットはVPC全体に適用される「メインルートテーブル」に従ってルーティングを行う
    - サブネット作成時に指定しないと上記が指定される
- VPCからインターネットへ接続する時にも使用する
  - インターネットゲートウェイに設定すると、サブネット内に発生した送信先がIGWへ転送して、インターネットへ接続できるようになる
- サブネットに1つ指定
- 1つのルートテーブルを複数サブネットで共有できる
- ネクストホップ(ゲートウェイ)
  - ルーティングテーブルに記載される

## セキュリティグループ

- VPC外とのネットワークアクセスを**インスタンスごとに制御**するファイアウォール
  - 1つはアタッチすること
- プロトコルとポート範囲、送受信先のCIDRや**セキュリティグループ**を指定

### ネットワークACL（アクセスコントロールリスト）

- VPC外とのネットワークアクセスを**サブネットごとに制御**するファイアウォール
- ユーザーが付与したルール番号の順番に評価され、ルール間で矛盾がある場合は小さい数字のルールが適用される
- **セキュリティグループ**の指定はできない

#### ネットワーク ACL とセキュリティグループの違い

- <https://milestone-of-se.nesuke.com/sv-advanced/aws/network-acl-and-security-group/>

|                | ネットワークACL                    | セキュリティグループ                 |
| -------------- | ---------------------------------- | ------------------------------------ |
| 主な機能       | **サブネットごとに**アクセス制御   | **インスタンスごとに**アクセス制御   |
| State          | ステートレス(通信の復路も検査)     | ステートフル(通信の復路は動的に許可) |
| ルール         | **許可・拒否**のどちらかを指定可能 | **許可ルールのみ**を指定可能         |
| 方向           | in と out で個別にルール設定可     | in と out で個別にルール設定可       |
| デフォルトin   | すべて許可                         | すべて拒否                           |
| デフォルトout  | すべて許可                         | すべて許可                           |
| ルール適用方法 | 指定した順番にルール適用           | すべてのルールを適用                 |

## ゲートウェイ

### インターネットゲートウェイ(IGW)

- インターネットとVPC内のAWSリソースを接続する機能
- VPCに1つだけアタッチ可能のため、複数のパブリックサブネットで共有して利用する
- 設定
  - デフォルトゲートウェイのID(0.0.0.0/0)
  - local(自分自身のCIDR 例:172.16.0.0/16)
    - 送信先が同一VPC内であれば、VPC内で直接送信する
- パブリックサブネットはIGW
- 冗長化、障害時復旧はAWS側で自動化されている

### NATゲートウェイ(Network Address Translation)

- プライベートサブネットからインターネットへの通信を可能にするIPv4専用の機能
- IPアドレスを別のIPアドレスに変換する機能のこと
- プライベートサブネット内にあるAWSリソースのプライベートIPアドレスを、NATゲートウェイのパブリックIPアドレス（Elastic IPアドレス）に変換し、インターネットへ接続する
- Elastic IPアドレスを割り当てたNATゲートウェイをパブリックサブネット内に作成する必要がある
- インターネットからプライベートサブネット内リソースへの接続開始要求は通さない
- NATゲートウェイはAZ内で冗長化されており、NATゲートウェイの機器障害時やトラフィック増加時でも継続して利用できる
  - **AZに障害が発生した場合には利用できなくなる**ため、さらに可用性を高める場合は複数のAZにそれぞれNATゲートウェイを配置する必要がある
- EC2インスタンスがインターネットと通信するにはパブリックIPを持っていないといけない
- マネージドサービス

- NATインスタンス
  - プライベートサブネットからインターネットへの通信を可能にするIPv4専用の機能
  - アンマネージドサービス(ユーザーが障害対応などの運用管理を実施する必要がある)
  - 利用方法
    - パブリックサブネットにパブリックIPアドレスまたはElastic IPアドレスを割り当てたNATインスタンスを作成
    - プライベートサブネットのルートテーブルにターゲットがNATインスタンスのルーティングを設定
  - NATゲートウェイでは利用できないポート転送機能を設定できる
  - VPC外からプライベートサブネット内へ接続する際の踏み台サーバーとして利用できる

### 仮想プライベートゲートウェイ(VGW)

- VPNやDirect Connectとの接続するための機能
- VPCに1つだけアタッチ可能
- 複数VPN,DCの接続可能
- ルーティング方法
  - IPべた書きかルート伝番(プロパゲーション)で動的反映

### Egress-Onlyインターネットゲートウェイ

- NATゲートウェイとインターネットゲートウェイの特徴を併せ持つ機能

## VPCエンドポイント

- セキュリティ上の制約でインターネットとの通信が制限されているプライベートサブネット内のAWSリソースから、インターネットを経由しなくてもプライベートネットワーク経由でVPC外のAWSサービスへアクセス可能にする機能
  - インターネット上のAWSサービスに接続する
  - インターフェースエンドポイント(PrivateLink)の場合は有償

### ピアリング接続

- 2つのVPCをプライベート接続する
- AWSアカウントを跨いだ接続も可能
- IGW,VGWへの接続はできない(EC2等と接続する)

### VPCフローログ

- VPC内の通信解析
- フローログデータは Amazon CloudWatch Logs または Amazon S3 に出力可能

## その他

### CIDR（Classless Inter-Domain Routing）

- ネットワークの範囲を指定するIPアドレスの設定方法
- プレフィックス長
  - IPアドレスとプレフィックス長によって所属するネットワークを決める(表記例：/24)

### ステートフル

- 以前の状態を**保持したまま**以後の処理に役立てる

### ステートレス

- 以前の状態を**保持せず**にその都度の処理を要求する
