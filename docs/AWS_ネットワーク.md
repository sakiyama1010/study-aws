# ネットワーク

## リージョン(拠点)

- 国や地域

## アベイラビリティゾーン

- データセンター
- 1つのAZは複数のデータセンターで構成されている
  - 地理的、電源的に独立した場所に配置
- 障害発生時(耐障害性)の為にサーバの AZ は分けるべき
- AZ 間は高速回線で接続されており、ネットワーク遅延(レイテンシー)は基本 2ms 以内

## VPC

- プライベートなネットワークをAWS上に作成する
- IGW(インターネットへの出口)を設定すると直接インターネットに出ることができる
  - インターネットからVPC内のEC2インスタンスへアクセスするために、必要な機能
- VGWを設定するとAWS Direct Connectや専用VPN回線との接続に使う
- VPC内に入れられないサービスもある(S3,CloudWatch,DynamoDB)
- VPC エンドポイント
  - インターネットゲートウェイや NAT ゲートウェイ、NAT インスタンスなどを経由することなく、VPC と他の AWS のサービスとをプライベートに接続できる AWS のサービス

## IPアドレス

- IPアドレス(CIDRブロック)を割り振れる(/16 ～ /28の範囲で可能)
- クラスAのIP帯でも/8は取れない
- プライベートIP
  - VPC内のリソース間の通信に使用し、インターネットとは通信不可のIP
  - パブリックサブネットとプライベートサブネットにあるEC2やRDSなど、すべてのインスタンスに割り当てられる
  - AWSリソースを停止・起動しても同一のIPアドレスが使われ、AWSリソースの削除時にIPアドレスが解放される
- パブリックIP
  - インターネットと通信可能なIP
  - パブリックIPアドレスを持つAWSリソースは、パブリックDNSホスト名が割り当てられる
  - パブリックDNSホスト名
    - 名前解決要求
      - VPC外からであればパブリックIPアドレスに解決
      - VPC内からであればプライベートIPアドレスに解決
  - AWSリソースが停止する時にIPアドレスが解放され、AWSリソースが起動する時に新規のIPアドレスが割り当てられる
- Elastic IP
  - インターネットと**通信可能な固定**のパブリックIP
  - AWSリソースが削除されても同一のIPアドレスが保有され、別のAWSリソースに再び割り当てることができる
  - パブリックDNSホスト名も固定になり、Elastic IPアドレスへ名前解決される
  - AWSリソースが**停止していたり、割り当てられていない時は料金が発生**する

## サブネット

- VPCを論理的に分割したネットワーク空間(アドレスレンジ)のこと
- VPCに設定したCIDRブロックの範囲内で設定可能
  - (/16 ～ /28の範囲で可能)
- サブネット内に**1つの仮想ルータがあるイメージ**
  - サブネット内にあるEC2のDGWになる

### パブリックサブネット

- インターネットから直接通信があるサブネット
  - Route tables で 0.0.0.0/0 (デフォルトゲートウェイへの通信) がインターネットゲートウェイに流れる
  - 例:インターネットから直接アクセスされるWebサーバー等で使う

### プライベートサブネット

- Route tables で 0.0.0.0/0 (デフォルトゲートウェイへの通信) がNATゲートウェイに流れ
- 内部としか通信しないサブネット
- DBサーバはこちらに置く

### 特徴・制約

- 一つのAZに属する
- 一つのAZ内に複数作成できる
- 作成時にAZを指定する、変更できない
- 1サブネットに1ルートテーブル指定できる
  - デフォルトはメインテーブルが指定され、変更可能
- 1サブネットに1ACL指定できる
  - デフォルトのACLが指定され、変更可能
- 1VPCに対して200個のサブネット作成可能(リクエストすることで拡張可能)
- 最初の4つと最後のアドレスは予約されていて使えない
  - CIDRブロックが「172.16.0.0/24」の予約IPアドレス（利用できないIPアドレス）
    - 172.16.0.0 … ネットワークアドレス
    - 172.16.0.1 … VPCルーター用
    - 172.16.0.2 … DNSサーバー用
    - 172.16.0.3 … 将来の利用のためにAWSで予約
    - 172.16.0.255… ネットワークブロードキャストアドレス
    - 1サブネット当たりのIPアドレス数 = 2^(32 - サブネットのプレフィックス長)-5
- IPアドレスの確保な必要なサービスがある
  - ELBの場合、IPアドレス8個は抑えないといけない
- 必要以上に分割するとアドレスの浪費に繋がる

## マルチAZ

- 同一の役割を持ったサブネットを複数のAZに配置する
  - AZを跨いだ構築をすることで、AZ障害に対して耐久性の高い設計にする思想

## ルートテーブル

- VPC内で発生した通信に対して、どこへデータを転送するかを定義する機能
- ルーティング
  - ルートテーブルに従って、送信先ごとに指定したターゲットへデータを転送すること
  - サブネット内の通信がどの宛先のネットワークに対して、どのコンポーネント（IGWとかEC2とか）に転送されて欲しいかを設定する
  - ルートテーブルの紐付けがないサブネットはVPC全体に適用される「メインルートテーブル」に従ってルーティングを行う
    - サブネット作成時に指定しないと上記が指定される
- VPCからインターネットへ接続する時にも使用する
  - インターネットゲートウェイに設定すると、サブネット内に発生した送信先がIGWへ転送して、インターネットへ接続できるようになる
- サブネットに1つ指定
- 1つのルートテーブルを複数サブネットで共有できる
- ネクストホップ(ゲートウェイ)
  - ルーティングテーブルに記載される

## セキュリティグループ

- VPC外とのネットワークアクセスを**インスタンスごとに制御**するファイアウォール
  - 1つはアタッチすること
- プロトコルとポート範囲、送受信先のCIDRや**セキュリティグループ**を指定

### ネットワークACL（アクセスコントロールリスト）

- VPC外とのネットワークアクセスを**サブネットごとに制御**するファイアウォール
- ユーザーが付与したルール番号の順番に評価され、ルール間で矛盾がある場合は小さい数字のルールが適用される
- **セキュリティグループ**の指定はできない

#### ネットワーク ACL とセキュリティグループの違い

- <https://milestone-of-se.nesuke.com/sv-advanced/aws/network-acl-and-security-group/>

|                | ネットワークACL                    | セキュリティグループ                 |
| -------------- | ---------------------------------- | ------------------------------------ |
| 主な機能       | **サブネットごとに**アクセス制御   | **インスタンスごとに**アクセス制御   |
| State          | ステートレス(通信の復路も検査)     | ステートフル(通信の復路は動的に許可) |
| ルール         | **許可・拒否**のどちらかを指定可能 | **許可ルールのみ**を指定可能         |
| 方向           | in と out で個別にルール設定可     | in と out で個別にルール設定可       |
| デフォルトin   | すべて許可                         | すべて拒否                           |
| デフォルトout  | すべて許可                         | すべて許可                           |
| ルール適用方法 | 指定した順番にルール適用           | すべてのルールを適用                 |

## ゲートウェイ

### インターネットゲートウェイ(IGW)

    - VPCとインターネットの接続
    - VPCに1つだけアタッチ可能
    - 基本デフォルトルートを指定(0.0.0.0/0)
      - パブリックサブネットはIGW
      - プライベートサブネットはNATGW
        - NATGWがグローバルIPに変換して通してくれる  

### 仮想プライベートゲートウェイ(VGW)

- VPNやDirect Connectとの接続
- VPCに1つだけアタッチ可能
- 複数VPN,DCの接続可能

- VPCエンドポイント
  - インターネット上のAWSサービスに接続する
  - インターフェースエンドポイント(PrivateLink)の場合は有償
- ピアリング接続
  - 2つのVPCをプライベート接続する
  - AWSアカウントを跨いだ接続も可能
  - IGW,VGWへの接続はできない(EC2等と接続する)
- VPCフローログ
  - VPC内の通信解析
  - フローログデータは Amazon CloudWatch Logs または Amazon S3 に出力可能

## 料金仕様

- リージョン
  - EC2 を扱うときに料金形態が変わる

VPCにいるだけで利用料金がかかってしまうリソース
<https://fu3ak1.hatenablog.com/entry/2020/07/02/233639>

### AWS サービスがどこにあるのか

<https://qiita.com/saitotak/items/d2ede050e7a2224da46d>

- グローバルサービス
- リージョンサービス
- AZ サービス

### DNS知識

<https://www.atmarkit.co.jp/fnetwork/rensai/dns01/dns-record.html>

- SOA : ゾーン（ドメイン）情報を記載
- NS : ドメインのDNSサーバ名を指定
- A : ホストのIPアドレス
- CNAME : ホスト名のエイリアス（別名
- MX : ドメインのメール・サーバ名
- TXT : ホストへのテキスト情報
Zone Apexとは、頭にサブドメインを伴わない、ドメイン名自体のこと。当該DNSゾーンの中で頂点（apex）にあたるドメイン名であるためこのように呼ばれる。

- CloudFront
  - CDNサービス
  - 利用者から最も近いエッジロケーション(データセンター)から配信される
  - 配信元となるオリジンサーバが必要
  - ディストリビューション(distribution 流通・分布)
    - ダウンロード(HTTP/HTTPSを用いたCSSや画像の配信)
    - ストリーミング(RTMPを用いた動画配信)
  - キャッシュルール
    - 拡張子やパスを指定してキャッシュ期間の指定が可能

- route 53
  - ドメイン管理、権威DNS
  - ドメイン取得からゾーン設定が可能
  - ドメインの年間利用料はAWS利用料に含まれる
    - 自動更新機能有
    - 権威DNS
      - あるゾーンの情報を保持し、他のサーバーに問い合わせることなく応答を返すことができるサーバーのこと
      - ドメインとIPの変換情報を保持したDNS
      - 変換情報を保持していないDNSをキャッシュDNSという
      - 保持した情報以外はリクエストしても応答しない
    - ホストゾーン
      - レコード情報の管理単位(基本ドメイン単位)
      - Aliasレコード
        - CloudFrontやELB,S3等のAWSリソースのFQDNを指定できる
      - NSレコード
        - Route53で作成した場合は、AWSのネームサーバが自動で設定される
      - ZONE APEX
        - route53の場合、ホストゾーン名
  - ルーティングポリシー
    - シンプル
      - 1対1
    - フェイルオーバー
      - ヘルスチェック失敗時にスタンバイ用のシステムへルーティングする
      - 障害発生時
    - 位置情報
      - ユーザーの位置情報でルーティングする
      - アクセス場所によって言語を変える
    - 地理的近接性
      - リソースの場所でルーティングする
      - トラフィックのある場所のリソースから別の場所のリソースに移動する
        - 例：AWS リソースを使用している場合は、リソースを作成した AWS リージョン
      - 使用するには、Route 53 トラフィックフロー.を使用する必要がある
    - レイテンシー
      - 遅延の最もすｋ内サーバにリクエストをルーティングする
    - 複数値回答
      - 1つのレコードに異なるIPを複数登録してランダムに返却されたIPへルーティングする
      - ヘルスチェックNGのサーバにはルーティングしない
      - 最大8つ
    - 加重
      - 指定した比率でルーティングする
      - リクエスト比率を調整する
  - トラフィックフロー
    - ルーティングエディタ(GUI)的な
  - DNSフェイルオーバー
    - route53のフォールトトレラント技術
      - サーバ停止被害を最小限に抑える仕組み

- CloudFormation
  - !Ref
    - テンプレートファイル内で指定したリソースの値を参照する
  - DependsOn
    - 特定リソースが他のリソースに続けて作成されるように指定する

## その他

### CIDR（Classless Inter-Domain Routing）

- ネットワークの範囲を指定するIPアドレスの設定方法
- プレフィックス長
  - IPアドレスとプレフィックス長によって所属するネットワークを決める(表記例：/24)

### ステートフル

- 以前の状態を**保持したまま**以後の処理に役立てる

### ステートレス

- 以前の状態を**保持せず**にその都度の処理を要求する
