# ネットワーク

## リージョン(拠点)

- 国や地域

## アベイラビリティゾーン

- データセンター
- 1つのAZは複数のデータセンターで構成されている
  - 地理的、電源的に独立した場所に配置
- 障害発生時(耐障害性)の為にサーバの AZ は分けるべき
- AZ 間は高速回線で接続されており、ネットワーク遅延(レイテンシー)は基本 2ms 以内

## VPC

- プライベートなネットワークをAWS上に作成する
- IGW(インターネットへの出口)を設定すると直接インターネットに出ることができる
- VGWを設定するとAWS Direct Connectや専用VPN回線との接続に使う
- VPC内に入れられないサービスもある(S3,CloudWatch,DynamoDB)
- VPC エンドポイント
  - インターネットゲートウェイや NAT ゲートウェイ、NAT インスタンスなどを経由することなく、VPC と他の AWS のサービスとをプライベートに接続できる AWS のサービス

## IPアドレス

- IPアドレス(CIDRブロック)を割り振れる(/16 ～ /28の範囲で可能)
- クラスAのIP帯でも/8は取れない

## サブネット

- VPC内部に作るアドレスレンジ
- VPCに設定したCIDRブロックの範囲内で設定可能
  - (/16 ～ /28の範囲で可能)
- 個々のサブネットには1つの仮想ルータがある
  - ルートテーブル、ネットワークACLの設定を持っている
  - サブネット内にあるEC2のDGWになる
- 作成時にAZを指定する、変更不可
- ルートテーブル/ACLを1つ指定可能で、変更可
- 1VPCに対して200個のサブネット作成可能(拡張可能)
- AZを跨いだ構築をすることで、AZ障害に対して耐久性の高い設計にする(マルチAZ)

### 制約

- 最初の4つと最後のアドレスは予約されており、使えない(24ビットマスクのサブネットの場合、0,1,2,3,255)
- 必要以上に分割するとアドレスの浪費に繋がる
- IPアドレスの確保な必要なサービスがある
  - ELBの場合、IPアドレス8個は抑えないといけない

### 種類

- パブリックとプライベートがある
  - public)Route tables で 0.0.0.0/0 (デフォルトゲートウェイへの通信) がインターネットゲートウェイに流れる
    - 外部と通信できるサブネット
    - APサーバはこちらに置く
  - (private)Route tables で 0.0.0.0/0 (デフォルトゲートウェイへの通信) がNATゲートウェイに流れ
    - 内部としか通信しないサブネット
    - DBサーバはこちらに置く

## ルートテーブル

    - ルーティング
      - ルートテーブル
        - サブネット内の通信がどの宛先のネットワークに対して、どのコンポーネント（IGWとかEC2とか）に転送されて欲しいかを設定する
        - サブネットに1つずつ指定
        - 1つのサブネットに複数ルートテーブルの指定はできない？
        - ネクストホップ
          - ルーティングテーブルに記載される
          - 個々の宛先ネットワーク毎に決められた、次に転送すべき隣接ルータ（のIPアドレス）のこと

## セキュリティグループ

- インスタンス単位で通信を制御する

      - インバウンド(外からVPC)、アウトバウンド(内部から外)
      - ステートフル(通信の復路は動的に許可)

### ネットワークACL（アクセスコントロールリスト）

      - デフォルトすべての通信許可
      - ステートレス(通信の復路も検査)
    - ↑2つの違い、状態保持があるかどうか
      - <https://milestone-of-se.nesuke.com/sv-advanced/aws/network-acl-and-security-group/>

- ゲートウェイ
  - インターネットゲートウェイ(IGW)
    - VPCとインターネットの接続
    - VPCに1つだけアタッチ可能
    - 基本デフォルトルートを指定(0.0.0.0/0)
      - パブリックサブネットはIGW
      - プライベートサブネットはNATGW
        - NATGWがグローバルIPに変換して通してくれる  
  - 仮想プライベートゲートウェイ(VGW)
    - VPNやDirect Connectとの接続
    - VPCに1つだけアタッチ可能
    - 複数VPN,DCの接続可能
  - VPCエンドポイント
    - インターネット上のAWSサービスに接続する
    - インターフェースエンドポイント(PrivateLink)の場合は有償
  - ピアリング接続
    - 2つのVPCをプライベート接続する
    - AWSアカウントを跨いだ接続も可能
    - IGW,VGWへの接続はできない(EC2等と接続する)
  - VPCフローログ
    - VPC内の通信解析
    - フローログデータは Amazon CloudWatch Logs または Amazon S3 に出力可能

## 料金仕様

- リージョン
  - EC2 を扱うときに料金形態が変わる

VPCにいるだけで利用料金がかかってしまうリソース
<https://fu3ak1.hatenablog.com/entry/2020/07/02/233639>

### AWS サービスがどこにあるのか

<https://qiita.com/saitotak/items/d2ede050e7a2224da46d>

- グローバルサービス
- リージョンサービス
- AZ サービス

### DNS知識

<https://www.atmarkit.co.jp/fnetwork/rensai/dns01/dns-record.html>

- SOA : ゾーン（ドメイン）情報を記載
- NS : ドメインのDNSサーバ名を指定
- A : ホストのIPアドレス
- CNAME : ホスト名のエイリアス（別名
- MX : ドメインのメール・サーバ名
- TXT : ホストへのテキスト情報
Zone Apexとは、頭にサブドメインを伴わない、ドメイン名自体のこと。当該DNSゾーンの中で頂点（apex）にあたるドメイン名であるためこのように呼ばれる。

- CloudFront
  - CDNサービス
  - 利用者から最も近いエッジロケーション(データセンター)から配信される
  - 配信元となるオリジンサーバが必要
  - ディストリビューション(distribution 流通・分布)
    - ダウンロード(HTTP/HTTPSを用いたCSSや画像の配信)
    - ストリーミング(RTMPを用いた動画配信)
  - キャッシュルール
    - 拡張子やパスを指定してキャッシュ期間の指定が可能

- route 53
  - ドメイン管理、権威DNS
  - ドメイン取得からゾーン設定が可能
  - ドメインの年間利用料はAWS利用料に含まれる
    - 自動更新機能有
    - 権威DNS
      - あるゾーンの情報を保持し、他のサーバーに問い合わせることなく応答を返すことができるサーバーのこと
      - ドメインとIPの変換情報を保持したDNS
      - 変換情報を保持していないDNSをキャッシュDNSという
      - 保持した情報以外はリクエストしても応答しない
    - ホストゾーン
      - レコード情報の管理単位(基本ドメイン単位)
      - Aliasレコード
        - CloudFrontやELB,S3等のAWSリソースのFQDNを指定できる
      - NSレコード
        - Route53で作成した場合は、AWSのネームサーバが自動で設定される
      - ZONE APEX
        - route53の場合、ホストゾーン名
  - ルーティングポリシー
    - シンプル
      - 1対1
    - フェイルオーバー
      - ヘルスチェック失敗時にスタンバイ用のシステムへルーティングする
      - 障害発生時
    - 位置情報
      - ユーザーの位置情報でルーティングする
      - アクセス場所によって言語を変える
    - 地理的近接性
      - リソースの場所でルーティングする
      - トラフィックのある場所のリソースから別の場所のリソースに移動する
        - 例：AWS リソースを使用している場合は、リソースを作成した AWS リージョン
      - 使用するには、Route 53 トラフィックフロー.を使用する必要がある
    - レイテンシー
      - 遅延の最もすｋ内サーバにリクエストをルーティングする
    - 複数値回答
      - 1つのレコードに異なるIPを複数登録してランダムに返却されたIPへルーティングする
      - ヘルスチェックNGのサーバにはルーティングしない
      - 最大8つ
    - 加重
      - 指定した比率でルーティングする
      - リクエスト比率を調整する
  - トラフィックフロー
    - ルーティングエディタ(GUI)的な
  - DNSフェイルオーバー
    - route53のフォールトトレラント技術
      - サーバ停止被害を最小限に抑える仕組み

- CloudFormation
  - !Ref
    - テンプレートファイル内で指定したリソースの値を参照する
  - DependsOn
    - 特定リソースが他のリソースに続けて作成されるように指定する
