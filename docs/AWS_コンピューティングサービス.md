# コンピューティングサービス

## AWS_EC2

Amazon EC2などAWSが提供する仮想サーバーのことを「インスタンス」

- 固有のOSの設定や、AMIに入っていないミドルウェアの導入はユーザーが実施する
- キーペアは、EC2インスタンスに安全に接続するための暗号鍵
  - AWS上に保管されるパブリックキーと、ユーザーの環境上に保管するプライベートキーの2つの鍵で構成される
- プレイスメントグループ
  - 複数のEC2インスタンスを1つのAZに配置してグループ化すること
- クラスタープレイスメントグループ
  - グループ内のEC2インスタンスは物理的に近い距離に配置されるため、通信の遅延が起こりにくく高速な通信が可能
- セキュリティグループ
  - EC2インスタンスに割り当てることによって、ネットワークアクセスを制御するファイアウォール機能のこと
- Amazon マシンイメージ（AMI）
  - EC2インスタンスに展開可能なOSやミドルウェアなどのテンプレート
  - EC2インスタンスはAMIから作成される
- インスタンスタイプ
  - EC2インスタンス作成時に選択できるCPU、メモリ、ストレージ性能、ネットワークキャパシティーの組み合わせ
  - 例：c4.large
- インスタンスファミリー
  - M:汎用
  - T:汎用(CPUバースト機能)
    - 一時的にCPUの高負荷が発生する小中規模のサーバ
  - C:コンピューティング最適化
  - R,X:メモリ最適化
  - P,G,F:高速コンピューティング
  - I,D,H:ストレージ最適化
    - I：高いディスクスループットを必要とするサーバ
- インスタンス世代
  - M5の5の部分
- インスタンスサイズ
  - large
- スポットインスタンス
  - 各AZの予備領域を入札形式で契約することによって、オンデマンドインスタンスよりも割安で利用できる課金形態
    - インスタンスが一部停止しても問題ないシステムに向いている
  - スポットフリート
    - 必要なインスタンス数を指定することで、指定した数のスポットインスタンスが起動
    - スポット価格が入札価格より上回りスポットインスタンスが終了した場合、自動的にインスタンスを補充してインスタンス数を維持する
    - 補充されるインスタンスには、オンデマンドインスタンスも含まれる
  - スポットブロック
    - EC2インスタンスが終了しない時間帯を指定するスポットインスタンスのオプション
- ハードウェア専有インスタンス
  - 他のAWSアカウントとは分離された専用ハードウェアでEC2インスタンスを利用できる購入オプション
  - 物理的なCPUソケット、コア数、ホストIDは確認できない
  - 同AWSアカウントのハードウェア専有インスタンスではないインスタンスと、ハードウェアを共有する可能性がある
  - インスタンス単位で契約する
- オンデマンドインスタンス(**短期向け**)
  - インスタンスの起動時間に基づいた課金形態
  - EC2インスタンスのデフォルトの購入オプション
  - 開発環境など、利用が短期間のシステムに向いている
- リザーブドインスタンス(**長期向け**)
  - 1年もしくは3年の長期契約を結ぶことによって、オンデマンドインスタンスよりも割安で利用できる購入オプション

- ブロックストレージ
  - インスタンスストア
    - EC2インスタンスから利用できる揮発性の（インスタンス稼働中にだけ利用可能な）ブロックストレージ
      - EC2インスタンスを停止・終了すると、保存したデータは削除される
    - 利用料金はEC2に含まれているため、インスタンスストア自体は無料で使用できる
    - 数百万IOPS

- ユーザーデータ(userdata)
  - ユーザーがEC2インスタンス作成時に自動実行させたいコマンドやスクリプト
  - 必須の設定項目ではない
- メタデータ
  - 実行中のインスタンスに関するデータ
    - /latest/meta-data/にアクセスして取得できる
- Dedicated Hosts（専有ホスト）
  - 他のEC2インスタンスとは分離された専用ハードウェアで利用できる購入オプション
  - 利用するソフトウェアライセンスの制約等で分ける必要がある場合

## ELB

- 負荷分散（ロードバランシング）
  - リクエストを処理するリソースを複数配置し、それらのリソースにリクエストの処理を分散する
    - レスポンスの遅延が発生しないようにする
- Elastic Load Balancing（ELB）
  - AWSが提供する負荷分散サービス
  - マネージドサービス
  - 負荷に応じてスケーリング
  - ヘルスチェック機能
    - インスタンスの正常動作を確認
    - DBサーバまでの応答を確認することもできる
- ターゲット
  - ELB配下の負荷分散先リソースのこと
  - ターゲットにはEC2などのインスタンスや、IPアドレス、Lambda関数が指定できる
- ターゲットグループ
  - 一つのELB配下で管理されるターゲットの集合
  - ターゲットをまとめたターゲットグループ単位に負荷分散を行う
  - AZ障害時の影響を少なくするためにも、ターゲットはマルチAZ（複数のAZに配置する構成）にするのが一般的
- SNI（Server Name Indication）
  - 暗号化通信で使用するサーバー証明書をパブリックIPアドレスではなくドメイン名によって判断する技術
  - SNIに対応したELBに複数のサーバー証明書を導入すると、ELBが宛先ドメイン名から適切なサーバー証明書を判断してサーバーへ通信を転送する
    - ALB,NLBが対応

- ALB
  - レイヤー7（アプリケーション層）で負荷分散を行う
  - HTTP、HTTPSをサポート
    - HTTP/2対応
  - WebSocket
    - ひとつのコネクション内で永続的にサーバー/クライアント双方からデータ送信できる技術
  - 同一インスタンス内の複数ポートへの負荷分散
  - ホストベースのルーティング
    - クライアントがリクエストした接続先URLのFQDNに従ってルーティングできる機能
  - パスベースのルーティング
- NLB
  - レイヤー4（トランスポート層）で負荷分散を行う
  - TCP、UDP、TLSをサポート
  - WebSocket
  - 同一インスタンス内の複数ポートへの負荷分散
  - Elasitc IPアドレス（固定のパブリックIPアドレス）と関連付ける
  - サーバーへのアクセスをドメイン名ではなくIPアドレスで行いたい
  - クライアントのアクセス先をIPアドレスで管理・制限している環境で使いたい
  - NLBのターゲットにALBを指定できる
    - クライアントからALB配下のサーバーにNLBのElastic IPアドレスでアクセスできる
- CLB
  - レイヤー7（アプリケーション層）およびレイヤー4（トランスポート層）で負荷分散を行う
  - HTTP、HTTPS、TCP、SSL/TLSをサポート
  - ALBやNLBより古いサービスでパフォーマンスが劣る
    - 基本的にはALBやNLBの利用が推奨されている

### Auto Scaling

- AWSリソースを負荷状況や設定したスケジュールに従って、自動的にスケーリングする機能
- Amazon EC2やAmazon ECS、Amazon DynamoDBなどで利用できる

#### Auto Scalingグループ

- 自動スケーリング対象の管理単位
  - 希望する容量(稼働するリソース数)
  - 最小キャパシティ(リソースの最小数)
  - 最大キャパシティ(リソースの最大数)
  - ターゲットグループ(対象ELBのターゲットグループ)
  - ヘルスチェックのタイプ
  - ヘルスチェックの猶予期間
  - インスタンスの保護
    - スケールイン発生時の削除対象から除外する
  - 終了ポリシー

#### Auto Scalingヘルスチェック

- EC2
  - インスタンスの「ステータスチェック」の結果を確認
- ELB
  - 応答状態の確認
    - リソースがEC2インスタンスの場合は強制的に「EC2」が有効になっている
    - 「EC2」と「ELB」を両方有効にできる
    - 「EC2」が有効、「ELB」が無効になっている場合
      - ELBからのヘルスチェックに応答がないインスタンスは負荷分散先からは除外される
      - EC2の「ステータスチェック」が正常であればインスタンスが終了しない
      - インスタンスが終了されないと新規インスタンスも起動されないため、最小キャパシティ未満のインスタンスで負荷分散することがありえる
ヘルスチェックの設定で「ELB」も有効にすると、ELBからのヘルスチェックに応答がないインスタンスが終了し、新たに正常なインスタンスが起動します。

- ヘルスチェックで異常となったリソースは、自動的に終了される
- ヘルスチェックの猶予期間
  - リソースが起動してから初回のヘルスチェックまでの待機時間
  - リソースが起動してアプリケーションなどが立ち上がる前にヘルスチェックが実行されてしまい、ヘルスチェックが異常になってしまうのを防ぐ為に設定

#### Auto Scalingの起動設定

- スケールアウトが発生した時に起動するリソースを設定できる
- EC2インスタンスの場合
  - AMI
  - インスタンスタイプ
  - セキュリティグループなど
    - EC2インスタンスを作成するための設定と同じ項目を指定する

#### オートスケールの終了ポリシー

- スケールインが発生した時に、どの優先順位でリソースを終了するかを設定
  - リソース数が最も多いAZ内で、以下の中から選択した優先順位でリソースが削除される
    - 最も起動時刻が過去のリソース
    - 最も起動時刻が新しいリソース
    - 最も作成時刻が過去の起動設定を利用して起動されたリソース
    - 次の課金タイミングが最も早いリソース
  - デフォルトの場合は「`最も作成時刻が過去の起動設定を利用して起動されたリソース`」
  - スケールイン時に特定のリソースが終了されないようにする
    - 「インスタンスの保護」を有効にする

#### スケーリングの発生条件

- 動的スケーリング
  - CPUやネットワークなどのパフォーマンスの負荷状況に応じて実施
  - スケーリングの発生条件となるメトリクスと、スケールアウト/インのアクションを「動的スケーリングポリシー」に設定
  - シンプルスケーリング
    - 特定のメトリクスに対する`1つのしきい値`に基づいて、インスタンスを増減
    - 例:300秒間の平均CPU使用率が50％を超えたら、インスタンスを1台追加する
  - ステップスケーリング
    - 特定のメトリクスに対する`複数のしきい値`に基づいて、インスタンスの増減を段階的に行う
    - 例:300秒間の平均CPU使用率が50％を超えたらインスタンスを1台追加し、90％を超えたら2台追加する
  - ターゲット追跡スケーリング
    - 特定のメトリクスが`指定した目標値になるように`、インスタンスを増減
    - 増減するインスタンス数はAWS側で調整される
    - 例:では、平均CPU使用率が30％になるように設定
- スケジュールに基づくスケーリング
  - スケジュールした日時に1回のみ、または定期的なスケジュールで自動的に実施
  - 例:毎日午前8時30分からインスタンス数を4台にするように設定
- 手動スケーリング
  - 作業者がバッチ処理など負荷の高い作業をする前に手動でリソースを増減する
  - 手動スケーリングはAuto Scalingグループの設定画面にて行う
  - 「希望するキャパシティ」に必要なリソース数を、リソースの「最小」以上、「最大」以下の数で入力

#### ライフサイクルフック

- スケーリング発生によるEC2インスタンスの起動または終了時に任意の処理を実行する機能
  - 例
    - スケールインによって終了するインスタンスにログを収集・退避させる
    - スケールアウトによって新たに追加したインスタンスに初期化スクリプトを実行させる
- スケーリング
  - <https://knowledge.sakura.ad.jp/6217/>

### 設計ポイント

- サーバをステートレス(状態保持しない)設計にすること
  - 例:スケールインで該当サーバが消えてしまうケース
- AZをまたがってインスタンスを配置する設計にすること
  - AZ全体の障害が発生したときにすべてのインスタンスが利用できなくなり、サービス全体が固まってしまう

いかにSPOFをなくすか、部分障害は起こり得ることを前提とする

## その他

- 単一障害点(Single Point Of Failure)
  - ある特定の部分が止まると全体が止まる箇所のこと
- スケールアウト/イン
  - サーバ台数の増減
- スケールアップ/ダウン
  - サーバスペックの増減
