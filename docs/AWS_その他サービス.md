# AWS知識

## CloudFront

- AWS上で動作する安全で高速なコンテンツ配信ネットワーク(CDN)
  - ライブストリーミングやオンデマンドストリーミングなどの動的コンテンツでも可能
- 利用者から物理的な距離が近いエッジロケーション(データセンター)から配信される

### バックエンド(オリジン)

- 元となるコンテンツを保持しているサーバのこと
  - EC2インスタンスやS3などのAWSサービス
  - オンプレミスのサーバーも設定可能

### ディストリビューション(distribution 流通・分布)

- オリジンサーバやキャッシュ等、コンテンツ配信に必要な情報を設定する
  - オリジンドメイン
    - S3、ELB等のAWSサービスもしくはドメイン名を指定
- ダウンロードディストリビューション
  - HTTP/HTTPSを用いたCSSや画像の配信
    - **S3の静的Webサイトホスティングで発行されるURLはHTTPのみで、HTTPS（暗号化通信）はサポートされていないが、CloudFrontは使える！**
- ストリーミングディストリビューション
  - RTMPを用いた動画のストリーミング配信
    - Real Time Messaging Protocol

### キャッシュルール

- 拡張子やパスを指定してキャッシュ期間の指定が可能
- キャッシュTTL(Time To Live)
  - キャッシュの保持時間でURLパスごとに指定可能
  - キャッシュTTLが超過した後にクライアントからのリクエストを受けると、オリジンサーバーにコンテンツの更新有無を確認
  - 更新されていればキャッシュに反映しつつ応答を返す
  - キャッシュTTLを含むキャッシュの設定のことを「キャッシュBehavior（ビヘイビア）」という
- キャッシュ削除(Invalidation)
  - エッジサーバに保存されているキャッシュを即座に削除できる機能
  - キャッシュを削除した後にクライアントからデータのリクエストを受け取ると、エッジサーバーは必ずオリジンサーバーへコンテンツを取得しにいく
    - クライアントへ配信するコンテンツが最新化される
  - 削除対象のデータはフォルダ名やファイル名で指定できる

### OAI（Origin Access Identity）

- S3バケット内のコンテンツへのアクセスをCloudFront経由でのアクセスに限定する
  - クライアントからS3バケットへ直接アクセスされないようにする機能
- クライアントからオリジナルコンテンツへの直接アクセスを制限することにより、オリジンサーバーのデータを保護する
  - オリジンサーバーにS3バケットを選択すると、OAIの設定が表示される
  - OAIを利用する時は、S3バケットのバケットポリシーにCloudFront経由のみアクセス可能にする設定を追加する

### 署名付きURL

- URLを知っている特定のクライアントが期限付きでコンテンツへアクセスできる機能
- S3の署名付きURLと同じく、CloudFront署名付きURLは非常に長いランダムな文字列で作成されているため、URLを知らない人が推測することはほぼ不可能
- 利用する時は、OAIを有効にしてS3バケットへ直接アクセスされないように設定する
- URL発行時に有効期限を設定すると、有効期限の過ぎたURLは無効になる

### 地理的制限

- クライアントからのアクセスを国別に制限できる機能
- クライアントの接続情報から接続元の国を判別
  - ホワイトリストに設定した国からのアクセスは許可
  - ブラックリストに設定した国からのアクセスは拒否
- 例えば、特定の国に対して法律上の理由でコンテンツの配信ができない場合などに利用する

## Route 53

- 権威DNSサーバー
- ドメイン名の購入
- ドメイン名の登録・管理
  - ドメインの年間利用料はAWS利用料に含まれる
    - 自動更新機能有

### Aliasレコード

- Route 53固有
- CloudFrontやELB,S3等のAWSリソースのFQDNを指定できる
  - AWSサービスの一部はドメイン名に割り当てられるIPアドレスが動的に変化する為、固定のIPアドレスを登録する必要があるAレコードを設定できない
    - 例えばELBのパブリックDNSホスト名や、S3の静的Webサイトホスティングのエンドポイント（URL）など
  - IPアドレスが動的に変化するAWSサービスに、独自ドメイン名を別名として割り当てたい場合はCNAMEレコードまたはエイリアスレコードを利用する
- エイリアスレコードはAWSサービスのドメイン名に割り当てた別名から直接IPアドレスへ名前解決ができるので、CNAMEレコードを使用するよりもDNSクエリへの応答が高速になる
- CNAMEレコードでは登録できない`Zone Apex`の別名を登録できる
- 権威DNSサーバーにZone Apexを設定する時、**Zone ApexのNSレコードを必ず登録する必要がある**
  - DNSの仕様に**CNAMEレコードは別レコードで登録されているドメイン名を登録できないという制約がある**
  - すでにNSレコードが登録されたZone Apexの別名はCNAMEレコードで登録できません。
  - ALBのドメイン名「example.us-east-1.elb.amazonaws.com」の別名として独自ドメイン名「example.com」をCNAMEレコードで登録しようとしても、「example.com」はZone Apexなので登録できない
  - エイリアスレコードを利用すれば「example.us-east-1.elb.amazonaws.com」の別名として「example.com」を登録できる

### ホストゾーン

- Route 53ではゾーン情報を「ホストゾーン」で管理する
- 管理対象となるドメイン名がホストゾーンの名前になる
- パブリックホストゾーン
  - インターネットなどVPC外に公開されたドメインのDNSレコードを管理する
- プライベートホストゾーン
  - VPC内に公開されたドメインのDNSレコードを管理する
    - VPC外からは名前解決できない
    - プライベートIPが返却されるはず

### トラフィックフロー

- ルーティングエディタ(GUI)
  - ルーティングポリシーの関係をツリー状に表示させ、複雑な設定を視覚的に分かりやすくしたもの

### DNSフェイルオーバー

- route53のフォールトトレラント技術
  - サーバ停止被害を最小限に抑える仕組み
  - webページが見れないときに一時的にソーリーページを出したいとき等

### トラフィックルーティング

- ルーティングポリシー
  - DNSクエリ（名前解決依頼）のドメイン名に対応するIPアドレスの中から回答するIPアドレスを決める方針のこと
- ルーティングポリシー種類
  - シンプルルーティングポリシー
    - 1対1
    - シンプルルーティングポリシー以外は、複数のルーティングポリシーを組み合わせることができる
  - 加重ルーティングポリシー
    - 複数のIPアドレスに対して**設定された重みづけに従って**IPアドレスを回答
    - リクエスト比率を調整する
      - 例:ABテスト
  - レイテンシールーティングポリシー
    - **遅延が最も小さいリージョン**にあるリソースのIPアドレスを回答
    - 基本的にクライアントから最も近いリージョンにあるリソースが選ばれますが、リソースまでの経路に遅延が発生している場合は、他の遅延が少ないリージョンにあるリソースが選ばれる
  - 位置情報ルーティングポリシー
    - クライアントの位置情報に基づいて、IPアドレスを回答
    - 例えばクライアントの位置情報から、クライアントの**使用言語**に合ったコンテンツがあるリソースのIPアドレスを回答する
  - 地理的近接性ルーティングポリシー
    - クライアントの位置情報を元に、クライアントと**地理的に近いリージョン**にあるリソースのIPアドレスを回答
    - トラフィックのある場所のリソースから別の場所のリソースに移動する
      - 例：AWS リソースを使用している場合は、リソースを作成した AWS リージョン
    - 使用するには、Route 53 トラフィックフローを使用する必要がある
  - 複数値回答ルーティングポリシー
    - 複数のリソースに対してヘルスチェックを行い、**最大8個の正常なリソースの中からランダム**に分散してIPアドレスを回答
    - ヘルスチェックの設定が必須
  - フェイルオーバールーティングポリシー
    - 通常時にアクセスさせたいリソースをプライマリに設定
    - プライマリに障害が発生した場合にアクセスさせたいリソースをセカンダリに設定
    - 通常時はプライマリに設定したリソースのIPアドレスを回答
    - プライマリのリソースにヘルスチェックで異常が発生した場合は、セカンダリに設定したリソースのIPアドレスを回答
      - リソースがプライマリからセカンダリへ自動的に切り替わる仕組みのことを「フェイルオーバー」という
    - ヘルスチェックの設定が必須

### DNS用語

- サブドメイン
  - ドメインの下位にあたるドメイン
- FQDN
  - 省略されずに指定されたドメイン名
- ゾーン
  - 権威DNSサーバが管理するドメイン範囲
- ゾーン情報
  - ゾーン内で管理するDNSレコードのまとまり
- DNSレコード
  - ドメイン名とIPアドレスの対応など、ドメインに関する登録情報
- ホストゾーン
  - レコード情報の管理単位
- Zone Apex
  - 頭にサブドメインを伴わない、ドメイン名自体のこと(最上位ドメイン)
  - 当該DNSゾーンの中で頂点（apex）にあたるドメイン名であるためこのように呼ばれる

### DNSサーバの種類

- 権威DNSサーバ
  - あるゾーンの情報を保持し、他のサーバーに問い合わせることなく応答を返すことができるサーバ
    - 自ドメインに関するDNSクエリ（名前解決依頼）を受け取った時に、自身が管理しているゾーン情報から回答する
  - ドメイン管理者がゾーン情報を登録する
  - 自ドメインの下位ドメインであるサブドメインに対して、他の権威DNSサーバーに権限を委任することで分散データベースを構成できる
    - 自ドメインのゾーン情報には、委任先のサブドメインと、そのサブドメインに権限のある権威DNSサーバーのDNSレコードを記載することで、サブドメインの権限を委任する
  - Route53は権威DNSサーバの為、保持しているドメイン以外の名前解決依頼をしても応答はしない
- キャッシュDNSサーバー
  - クライアントからDNSクエリを受け取り、権威DNSサーバーにDNSクエリを反復して送るサーバ
  - 権威DNSサーバーから受け取った応答結果を、クライアントへ返しつつ自身にキャッシュする
  - キャッシュされたものと同一のDNSクエリを受け取った場合は、キャッシュから応答を返すことで応答速度が向上させる

### レコード

<https://www.atmarkit.co.jp/fnetwork/rensai/dns01/dns-record.html>

- SOA : ゾーン（ドメイン）情報を記載
- NS : ドメインのDNSサーバ名を指定
- A : ホストのIPアドレス
- CNAME : ホスト名のエイリアス（別名
- MX : ドメインのメール・サーバ名
- TXT : ホストへのテキスト情報

## クラウド知識

- サービスモデル
  - SaaS (Software as a Service)
    - アプリケーションを含むすべての機能を提供するサービス
  - PaaS (Platform as a Service)
    - OSやミドルウェア、ランタイムなどのアプリケーション実行環境を含むプラットフォームを提供するサービス
  - IaaS(Infrastructure as a Service)
    - ネットワークやストレージを含むサーバー機能を提供するサービス
    - ユーザーはサーバーのスペックを選択し、OSやミドルウェアの導入する

## AWSについて

- AWSのリソースを操作する手段
  - AWSマネジメントコンソール
  - AWSコマンドラインインターフェイス（awscli）
  - SDK
- セキュリティ
  - セキュリティ対策の責任をAWSとユーザーで分担する「責任共有モデル」
  - AWS責任を持って管理するもの
    - AWSのサービスが稼働するハードウェアのセキュリティ対策
      - ネットワーク機器のファームウェアのバージョンアップ
      - 不要になった物理ディスクの破棄
    - AWSのサービスが稼働するデータセンターのセキュリティ対策
      - データセンターの入退室管理
    - ハイパーバイザー（ホストOS）のパッチ適用、セキュリティ対策
      - 仮想化環境を実現するための土台となる仮想化ソフトウェアやOSのこと
      - ハイパーバイザーなどの仮想環境上で動作するOSのことを「ゲストOS」
      - ハイパーバイザー（ホストOS）へのセキュリティパッチの適用
  - ユーザー責任
    - AWSサービスを利用するにあたって作成した認証情報
    - AWSサービスへのアクセス権限
      - ユーザーが作成したAWSアカウントの管理
    - 仮想サーバー上のデータやログ
      - ユーザーが保存したデータの暗号化
      - データベース監査ログの管理
      - **ゲストOS**へのセキュリティパッチの適用
- Well-Architected Framework
  - AWSが提唱するクラウド設計・運用のベストプラクティス集
  - 「一般的な設計原則」に従った設計
    - システムの作成や複製の処理を自動化することで、新機能の適用や動作確認といった実験的な作業が容易にできる
- エッジロケーション
  - ユーザーと直接通信するAWSデータセンター
- アベイラビリティーゾーン
  - リージョン内の物理的および論理的に区切られたデータセンター（群）
- リージョン
  - 世界中のAWSデータセンターを地域で区切ったもの
- グローバル
  - 全世界で共通して利用できるAWSサービスの範囲

## 権限

### AWS IAM（Identity and Access Management）

- IAMポリシー
  - IAMユーザー、IAMグループに対して権限を付与できる
- AWS Organizations
  - 複数のAWSアカウントをまとめて管理する機能
  - 管理するAWSアカウントに対して権限設定
  - 管理するAWSアカウントへの請求情報をひとまとめにする
  - Organizationsでは複数の組織を階層構造で管理する

### AWS KMS（Key Management Service）

- 暗号化に使用する鍵（キー）を作成・管理するサービス
  - 暗号化を行う対象のサービス（Amazon S3やEBS（Elastic Block Store）、Amazon Redshiftなど）と連携して利用
  - 暗号化鍵をAWSクラウド上で管理する
  - 暗号化鍵の管理はAWSによって行われる

## ログ

### Amazon CloudWatch

- メトリクス
  - 標準メトリクス
    - CPU使用率、ディスクIO、ネットワーク使用率
  - カスタムメトリクス
    - メモリ使用量
    - ディスクの空き容量、使用状況
    - プロセス情報

## 料金仕様

- リージョン
  - EC2 を扱うときに料金形態が変わる

VPCにいるだけで利用料金がかかってしまうリソース
<https://fu3ak1.hatenablog.com/entry/2020/07/02/233639>

### AWS サービスがどこにあるのか

<https://qiita.com/saitotak/items/d2ede050e7a2224da46d>

- グローバルサービス
- リージョンサービス
- AZ サービス

- CloudFormation
  - !Ref
    - テンプレートファイル内で指定したリソースの値を参照する
  - DependsOn
    - 特定リソースが他のリソースに続けて作成されるように指定する
